<h2 mat-dialog-title>Cuenta - {{ data.table.clave }}</h2>

<div mat-dialog-content>

  <form (ngSubmit)="submit()" [formGroup]="form">
    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 16px; margin-bottom: 16px;">

      <mat-form-field>
        <mat-label>Habitacion</mat-label>
        <input matInput formControlName="room">
        @if (form.controls.room.touched && form.controls.room.errors) {
        <mat-error>
          {{ form.controls.room.errors['required'] && 'Campo obligatorio.' }}
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field>
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name">
        @if (form.controls.name.touched && form.controls.name.errors) {
        <mat-error>
          {{ form.controls.name.errors['required'] && 'Campo obligatorio.' }}
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field>
        <mat-label>Credito</mat-label>
        <input matInput disabled [value]="bill?.credito | currency">
      </mat-form-field>

    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px;">

      <mat-form-field>
        <mat-label>Mesero</mat-label>
        <mat-select formControlName="waiter">
          @for (w of waiters; track w.idpvUsuarios) {
          <mat-option [value]="w.idpvUsuarios">{{ w.nombre }}</mat-option>
          }
        </mat-select>
        @if (form.controls.waiter.touched && form.controls.waiter.errors) {
        <mat-error>
          {{ form.controls.waiter.errors['required'] && 'Campo obligatorio.' }}
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field>
        <mat-label>Adultos</mat-label>
        <mat-select formControlName="adults">
          @for (n of [] | range : 10 : 0; track n) {
          <mat-option [value]="n">{{ n }}</mat-option>
          }
        </mat-select>
        @if (form.controls.adults.touched && form.controls.adults.errors) {
        <mat-error>
          {{ form.controls.adults.errors['required'] && 'Campo obligatorio.' }}
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field>
        <mat-label>Menores</mat-label>
        <mat-select formControlName="minors">
          @for (n of [] | range : 10 : 0; track n) {
          <mat-option [value]="n">{{ n }}</mat-option>
          }
        </mat-select>
        @if (form.controls.minors.touched && form.controls.minors.errors) {
        <mat-error>
          {{ form.controls.minors.errors['required'] && 'Campo obligatorio.' }}
        </mat-error>
        }
      </mat-form-field>

    </div>
  </form>

  <label style="display: block; margin-top: 16px; margin-bottom: 8px; font-weight: 500;">Comandas</label>
  <table mat-table [dataSource]="bill?.comandas || []" style="width: 100%;">

    <ng-container matColumnDef="folio">
      <th mat-header-cell *matHeaderCellDef>Folio</th>
      <td mat-cell *matCellDef="let command">{{ command.folio }}</td>
    </ng-container>

    <ng-container matColumnDef="cuenta">
      <th mat-header-cell *matHeaderCellDef>Cuenta</th>
      <td mat-cell *matCellDef="let command">
        <mat-form-field style="width: 60px;" subscriptSizing="dynamic">
          <mat-select [ngModel]="command.cuenta" (ngModelChange)="changeSub(command, $event)"
            [disabled]="form.disabled">
            @for (n of [] | range : 5 : 1; track n) {
            <mat-option [value]="n">{{ n }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </td>
    </ng-container>

    <ng-container matColumnDef="platillo">
      <th mat-header-cell *matHeaderCellDef>Platillo</th>
      <td mat-cell *matCellDef="let command">{{ command.platillo }}</td>
    </ng-container>

    <ng-container matColumnDef="cantidad">
      <th mat-header-cell *matHeaderCellDef>Cantidad</th>
      <td mat-cell *matCellDef="let command" style="text-align: right;">
        <span [style.color]="!command.estatus ? '#f44336' : undefined">
          {{ !command.estatus ? -command.cantidad : command.cantidad }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="precio">
      <th mat-header-cell *matHeaderCellDef style="text-align: right;">Precio</th>
      <td mat-cell *matCellDef="let command" style="text-align: right;">
        <span [style.color]="!command.estatus ? '#f44336' : undefined">
          {{ command.precio | currency }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="total">
      <th mat-header-cell *matHeaderCellDef style="text-align: right;">Total</th>
      <td mat-cell *matCellDef="let command" style="text-align: right;">
        <span [style.color]="!command.estatus ? '#f44336' : undefined">
          {{ (!command.estatus ? -command.total : command.total) | currency }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let command">
        @if (command.estatus) {
        <button mat-icon-button [disabled]="form.disabled" (click)="printOrder(command)">
          <mat-icon>print</mat-icon>
        </button>
        }
        @if (command.estatus && auth.user.permisos.cancelaciones) {
        <button mat-icon-button color="warn" [disabled]="form.disabled" (click)="cancelCommand(command)">
          <mat-icon>delete</mat-icon>
        </button>
        }
      </td>
    </ng-container>

    <ng-container matColumnDef="subtotal">
      <td mat-footer-cell *matFooterCellDef colspan="5" style="text-align: right; font-weight: bold;">Subtotal</td>
    </ng-container>
    <ng-container matColumnDef="subtotal-value">
      <td mat-footer-cell *matFooterCellDef style="text-align: right; font-weight: bold;">
        {{ bill?.total | currency }}
      </td>
    </ng-container>

    <ng-container matColumnDef="creditos">
      <td mat-footer-cell *matFooterCellDef colspan="5" style="text-align: right; font-weight: bold;">Creditos</td>
    </ng-container>
    <ng-container matColumnDef="creditos-value">
      <td mat-footer-cell *matFooterCellDef style="text-align: right; font-weight: bold;">
        {{ bill?.credito | currency }}
      </td>
    </ng-container>

    <ng-container matColumnDef="descuentos">
      <td mat-footer-cell *matFooterCellDef colspan="5" style="text-align: right; font-weight: bold;">Descuentos</td>
    </ng-container>
    <ng-container matColumnDef="descuentos-value">
      <td mat-footer-cell *matFooterCellDef style="text-align: right; font-weight: bold;">
        {{ (bill?.descuentos || 0) | currency }}
      </td>
    </ng-container>

    <ng-container matColumnDef="saldo">
      <td mat-footer-cell *matFooterCellDef colspan="5" style="text-align: right; font-weight: bold;">Saldo</td>
    </ng-container>
    <ng-container matColumnDef="saldo-value">
      <td mat-footer-cell *matFooterCellDef style="text-align: right; font-weight: bold;">
        {{ (bill?.credito + bill?.descuentos - bill?.total) | currency }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="['folio', 'cuenta', 'platillo', 'cantidad', 'precio', 'total', 'actions']">
    </tr>
    <tr mat-row
      *matRowDef="let row; columns: ['folio', 'cuenta', 'platillo', 'cantidad', 'precio', 'total', 'actions'];"></tr>
    <tr mat-footer-row *matFooterRowDef="['subtotal', 'subtotal-value']"></tr>
    <tr mat-footer-row *matFooterRowDef="['creditos', 'creditos-value']"></tr>
    <tr mat-footer-row *matFooterRowDef="['descuentos', 'descuentos-value']"></tr>
    <tr mat-footer-row *matFooterRowDef="['saldo', 'saldo-value']"></tr>
  </table>
</div>

<mat-progress-bar [mode]="form.disabled ? 'indeterminate': 'determinate'"></mat-progress-bar>

<div mat-dialog-actions>
  @if (auth?.user?.permisos?.comandarotros || auth.user.idpvUsuarios == bill.idpvUsuarios) {
  <button matButton="filled" (click)="order()" [disabled]="form.disabled">
    Comandar
  </button>
  }
  @if (auth?.user?.permisos?.cobrar) {
  <button matButton="filled" (click)="pay()" [disabled]="form.disabled">
    Cobrar
  </button>
  }
  @if (auth?.user?.permisos?.imprimircheque) {
  <button matButton="filled" (click)="printCheck()" [disabled]="form.disabled">
    Imprimir cheque
  </button>
  }
  @if (auth?.user?.permisos?.descuentos) {
  <button matButton="filled" (click)="discount()" [disabled]="form.disabled">
    Descuento
  </button>
  }
  @if (auth?.user?.permisos?.cambiomesa) {
  <button matButton="filled" (click)="changeTable()" [disabled]="form.disabled">
    Transferir
  </button>
  }
  <div style="flex-grow: 1;"></div>
  <button matButton (click)="cancel()" [disabled]="form.disabled">
    Cerrar
  </button>
  <button matButton="filled" (click)="submit()" [disabled]="form.disabled">
    Guardar
  </button>
</div>
